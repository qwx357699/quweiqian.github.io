(window.webpackJsonp=window.webpackJsonp||[]).push([[201],{375:function(t,a,s){"use strict";s.r(a);var r=s(10),e=function(t){t.options.__data__block__={mermaid_382ee16a:"sequenceDiagram\n客户端->>服务器: head请求，询问文件信息\n服务器->>客户端: Content-Disposition,Accept-Ranges,Content-Length\n客户端->>服务器: Range:bytes=0-500\n服务器->>客户端: 0-500字节的数据\n客户端->>服务器: Range:bytes=501-1000\n服务器->>客户端: 501-1000字节的数据\n客户端->>服务器: ...\n服务器->>客户端: ...\n客户端->>客户端: 将碎片信息组装成完整文件\n",mermaid_382ee23f:"sequenceDiagram\nNote left of 客户端: 用户选择文件\nNote left of 客户端: 将文件分割为多个分片\nNote left of 客户端: 得到文件的MD5和每个分片的MD5\n客户端->>服务器: 文件MD5、后缀、分片顺序、每个分片MD5\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 所有分片已上传\nNote right of 服务器: 合并所有分片成完整的文件\n服务器->>客户端: 文件的访问地址\n"}},p=Object(r.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"断点续传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#断点续传"}},[t._v("#")]),t._v(" 断点续传")]),t._v(" "),a("p",[a("a",{attrs:{href:t.$withBase("/codes/断点续传.zip")}},[t._v("示例服务器代码")])]),t._v(" "),a("h2",{attrs:{id:"下载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载"}},[t._v("#")]),t._v(" 下载")]),t._v(" "),a("p",[t._v("若要实现下载时的断点续传，首先，服务器在响应时，要在头中加入下面的字段")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Accept-Ranges: bytes\n")])])]),a("p",[t._v("这个字段是向客户端表明：我这个文件可以支持传输部分数据，你只需要告诉我你需要的是哪一部分的数据即可，单位是字节")]),t._v(" "),a("p",[t._v("此时，某些支持断点续传的客户端，比如迅雷，它就可以在请求时，告诉服务器需要的数据范围。具体做法是在请求头中加入下面的字段")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Range: bytes=0-5000\n")])])]),a("p",[t._v("客户端告诉服务器：请给我传递0-5000字节范围内的数据即可，无须传输全部数据")]),t._v(" "),a("p",[t._v("完整流程如下")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_382ee16a",graph:t.$dataBlock.mermaid_382ee16a}}),a("hr"),t._v(" "),a("p",[a("em",[t._v("理解补充：")])]),t._v(" "),a("ol",[a("li",[t._v("有的客户端同时请求，多个片段，加快速度，充分利用带宽。迅雷就是发送多个请求。")]),t._v(" "),a("li",[t._v("实际没有这么短 500 ，一般直接1M，现在网速比较快")]),t._v(" "),a("li",[t._v("总之，客户端的行为也会影响上面传送的逻辑。")]),t._v(" "),a("li",[t._v("需要客户端和服务端共同来完成")]),t._v(" "),a("li",[a("code",[t._v("Range:bytes=0-500")]),t._v(" 对应 "),a("code",[t._v("Accept-Ranges: bytes")]),t._v("，按字节划分的原因根据服务端的返回定的")]),t._v(" "),a("li",[t._v("对于前端不需要管。除非浏览器插件，页面上实现断点下载是不行的，因为保存不了临时文件")]),t._v(" "),a("li",[t._v("怎么完成断点下载呢？假设停电了，下次启动请求下载时，检验临时文件，跳过已下载文件。")]),t._v(" "),a("li",[t._v("206 Partial Content 状态码表示当前结果是文件的部分")])]),t._v(" "),a("hr"),t._v(" "),a("h2",{attrs:{id:"上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传"}},[t._v("#")]),t._v(" 上传")]),t._v(" "),a("p",[t._v("整体来说，实现断点上传的主要思路就是把要上传的文件切分为多个小的数据块然后进行上传")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://mdrs.yuanjin.tech/img/20210918140242.png",alt:"image-20210918140242356"}})]),t._v(" "),a("p",[t._v("虽然分片上传的整体思路一致，但它没有一个统一的、具体的标准，因此需要根据具体的业务场景制定自己的标准。")]),t._v(" "),a("p",[t._v("由于标准的不同，这也就意味着分片上传需要自行编写代码实现。")]),t._v(" "),a("p",[t._v("下面用一种极其简易的流程实现分片上传")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_382ee23f",graph:t.$dataBlock.mermaid_382ee23f}}),a("hr"),t._v(" "),a("p",[a("em",[t._v("补充：")])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("md5")]),t._v(" "),a("ul",[a("li",[t._v("不管文件大小，生成的 哈希值长度一致，")]),t._v(" "),a("li",[t._v("哈希算法对文件改动非常敏感")]),t._v(" "),a("li",[t._v("这里使用 md5 代表文件内容和编号")])])]),t._v(" "),a("li",[a("p",[t._v("第一步：这里的意思是请求后，服务端检查的几种情况")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("上传过")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("没传完")]),t._v(" "),a("p",[t._v("没传完，检查哪个 md5 片段没传完，告诉客户端，客户端根据消息继续传。")])]),t._v(" "),a("li",[a("p",[t._v("已传完")]),t._v(" "),a("p",[t._v("检查后发现已存在，直接返回地址就ok。")])])])]),t._v(" "),a("li",[a("p",[t._v("没上传过")]),t._v(" "),a("p",[t._v("记录信息，告诉浏览器哪些 md5 片段没传完，客户端根据消息继续传")])])]),t._v(" "),a("blockquote",[a("p",[t._v("个人理解：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("请求的整个文件的 md5 作用是服务器直接检查文件，是否传过")])]),t._v(" "),a("li",[a("p",[t._v("分片的 md5 是用来检查 临时文件的。")])])])])]),t._v(" "),a("li",[a("p",[t._v("这里简单实现，有些问题没考虑：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("服务端")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("分片乱序上传怎么处理")])]),t._v(" "),a("li",[a("p",[t._v("迸发的时候，同时上传多个分片怎么处理")])]),t._v(" "),a("li",[a("p",[t._v("多个用户同时上传不同的分片怎么处理")])]),t._v(" "),a("li",[a("p",[t._v("...")])])])]),t._v(" "),a("li",[a("p",[t._v("客户端")]),t._v(" "),a("ul",[a("li",[t._v("一个一个上传可能很慢，那么直接一次性发送多个，利用多线程同时上传（work 中可以用ajax）")])])])])])]),t._v(" "),a("h2",{attrs:{id:"示例服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例服务器"}},[t._v("#")]),t._v(" 示例服务器")]),t._v(" "),a("h3",{attrs:{id:"下载-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载-2"}},[t._v("#")]),t._v(" 下载")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper1.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper2.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper3.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper4.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper5.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper6.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper7.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper8.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper9.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper10.jpg")]),t._v(" "),a("h3",{attrs:{id:"上传-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传-2"}},[t._v("#")]),t._v(" 上传")]),t._v(" "),a("h4",{attrs:{id:"文件信息协商"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件信息协商"}},[t._v("#")]),t._v(" 文件信息协商")]),t._v(" "),a("p",[a("strong",[t._v("请求路径")]),t._v("：/api/upload/handshake")]),t._v(" "),a("p",[a("strong",[t._v("请求方法")]),t._v("：POST")]),t._v(" "),a("p",[a("strong",[t._v("字段")]),t._v("：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("字段名")]),t._v(" "),a("th",[t._v("含义")]),t._v(" "),a("th",[t._v("是否必须")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("fileId")]),t._v(" "),a("td",[t._v("文件的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("ext")]),t._v(" "),a("td",[t._v("文件的后缀，例如：.jpg")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("chunkIds")]),t._v(" "),a("td",[t._v("文件分片的编号数组，每个编号是一个MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td"),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("strong",[t._v("可能的响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://localhost:8000/upload/a32d18.jpg'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器已有该文件，无须上传")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-5'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器还需要上传的分片")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("可能发生的失败响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'请携带文件编号'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"分片上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分片上传"}},[t._v("#")]),t._v(" 分片上传")]),t._v(" "),a("p",[a("strong",[t._v("请求路径")]),t._v("：/api/upload")]),t._v(" "),a("p",[a("strong",[t._v("请求方法")]),t._v("：POST")]),t._v(" "),a("p",[a("strong",[t._v("字段")]),t._v("：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("字段名")]),t._v(" "),a("th",[t._v("含义")]),t._v(" "),a("th",[t._v("是否必须")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("file")]),t._v(" "),a("td",[t._v("分片的二进制数据")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("chunkId")]),t._v(" "),a("td",[t._v("分片的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("fileId")]),t._v(" "),a("td",[t._v("分片所属文件的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td"),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("strong",[t._v("上传成功的响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-5'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器还需要上传的分片")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("可能发生的失败响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'请携带文件编号'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])],1)}),[],!1,null,null,null);"function"==typeof e&&e(p);a.default=p.exports}}]);