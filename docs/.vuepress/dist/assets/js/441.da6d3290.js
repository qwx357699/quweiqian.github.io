(window.webpackJsonp=window.webpackJsonp||[]).push([[441],{807:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"tree-shaking-ignore"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tree-shaking-ignore"}},[s._v("#")]),s._v(" tree shaking {ignore}")]),s._v(" "),t("blockquote",[t("p",[s._v("压缩可以移除模块内部的无效代码\ntree shaking 可以移除模块之间的无效代码")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qwq9527.gitee.io/resource/imgs/sharking.gif",alt:"苹果摇晃的图片"}})]),s._v(" "),t("h1",{attrs:{id:"背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),t("p",[s._v("某些模块导出的代码并不一定会被用到")]),s._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// myMath.js")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"add"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sub")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sub"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// index.js")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("add"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./myMath"')]),s._v("\nconsole"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),t("p",[s._v("tree shaking 用于移除掉不会用到的导出")]),s._v(" "),t("h1",{attrs:{id:"使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[s._v("#")]),s._v(" 使用")]),s._v(" "),t("p",[t("code",[s._v("webpack2")]),s._v("开始就支持了"),t("code",[s._v("tree shaking")])]),s._v(" "),t("p",[s._v("只要是生产环境，"),t("code",[s._v("tree shaking")]),s._v("自动开启")]),s._v(" "),t("h1",{attrs:{id:"原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),t("p",[s._v("webpack会从入口模块出发寻找依赖关系")]),s._v(" "),t("p",[s._v("当解析一个模块时，webpack会根据ES6的模块导入语句来判断，该模块依赖了另一个模块的哪个导出")]),s._v(" "),t("p",[s._v("webpack之所以选择ES6的模块导入语句，是因为ES6模块有以下特点：")]),s._v(" "),t("ol",[t("li",[s._v("导入导出语句只能是顶层语句")]),s._v(" "),t("li",[s._v("import的模块名只能是字符串常量")]),s._v(" "),t("li",[s._v("import绑定的变量是不可变的")])]),s._v(" "),t("p",[s._v("这些特征都非常有利于分析出稳定的依赖")]),s._v(" "),t("p",[s._v("在具体分析依赖时，webpack坚持的原则是："),t("strong",[s._v("保证代码正常运行，然后再尽量tree shaking")])]),s._v(" "),t("p",[s._v("所以，如果你依赖的是一个导出的对象，由于JS语言的动态特性，以及"),t("code",[s._v("webpack")]),s._v("还不够智能，为了保证代码正常运行，它不会移除对象中的任何信息")]),s._v(" "),t("p",[s._v("因此，我们在编写代码的时候，"),t("strong",[s._v("尽量")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("使用"),t("code",[s._v("export xxx")]),s._v("导出，而不使用"),t("code",[s._v("export default {xxx}")]),s._v("导出")]),s._v(" "),t("li",[s._v("使用"),t("code",[s._v('import {xxx} from "xxx"')]),s._v("导入，而不使用"),t("code",[s._v('import xxx from "xxx"')]),s._v("导入")])]),s._v(" "),t("p",[s._v("依赖分析完毕后，"),t("code",[s._v("webpack")]),s._v("会根据每个模块每个导出是否被使用，标记其他导出为"),t("code",[s._v("dead code")]),s._v("，然后交给代码压缩工具处理")]),s._v(" "),t("p",[s._v("代码压缩工具最终移除掉那些"),t("code",[s._v("dead code")]),s._v("代码")]),s._v(" "),t("h1",{attrs:{id:"使用第三方库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用第三方库"}},[s._v("#")]),s._v(" 使用第三方库")]),s._v(" "),t("p",[s._v("某些第三方库可能使用的是"),t("code",[s._v("commonjs")]),s._v("的方式导出，比如"),t("code",[s._v("lodash")])]),s._v(" "),t("p",[s._v("又或者没有提供普通的ES6方式导出")]),s._v(" "),t("p",[s._v("对于这些库，"),t("code",[s._v("tree shaking")]),s._v("是无法发挥作用的")]),s._v(" "),t("p",[s._v("因此要寻找这些库的"),t("code",[s._v("es6")]),s._v("版本，好在很多流行但没有使用的"),t("code",[s._v("ES6")]),s._v("的第三方库，都发布了它的"),t("code",[s._v("ES6")]),s._v("版本，比如"),t("code",[s._v("lodash-es")])]),s._v(" "),t("h1",{attrs:{id:"作用域分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作用域分析"}},[s._v("#")]),s._v(" 作用域分析")]),s._v(" "),t("p",[t("code",[s._v("tree shaking")]),s._v("本身并没有完善的作用域分析，可能导致在一些"),t("code",[s._v("dead code")]),s._v("函数中的依赖仍然会被视为依赖")]),s._v(" "),t("p",[s._v("插件"),t("code",[s._v("webpack-deep-scope-plugin")]),s._v("提供了作用域分析，可解决这些问题")]),s._v(" "),t("h1",{attrs:{id:"副作用问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#副作用问题"}},[s._v("#")]),s._v(" 副作用问题")]),s._v(" "),t("p",[s._v("webpack在"),t("code",[s._v("tree shaking")]),s._v("的使用，有一个原则："),t("strong",[s._v("一定要保证代码正确运行")])]),s._v(" "),t("p",[s._v("在满足该原则的基础上，再来决定如何"),t("code",[s._v("tree shaking")])]),s._v(" "),t("p",[s._v("因此，当"),t("code",[s._v("webpack")]),s._v("无法确定某个模块是否有副作用时，它往往将其视为有副作用")]),s._v(" "),t("p",[s._v("因此，某些情况可能并不是我们所想要的")]),s._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//common.js")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" n  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Math"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("random")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//index.js")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./common.js"')]),s._v("\n")])])]),t("p",[s._v("虽然我们根本没用有"),t("code",[s._v("common.js")]),s._v("的导出，但"),t("code",[s._v("webpack")]),s._v("担心"),t("code",[s._v("common.js")]),s._v("有副作用，如果去掉会影响某些功能")]),s._v(" "),t("p",[s._v("如果要解决该问题，就需要标记该文件是没有副作用的")]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("package.json")]),s._v("中加入"),t("code",[s._v("sideEffects")])]),s._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"sideEffects"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("有两种配置方式：")]),s._v(" "),t("ul",[t("li",[s._v("false：当前工程中，所有模块都没有副作用。注意，这种写法会影响到某些css文件的导入")]),s._v(" "),t("li",[s._v("数组：设置哪些文件拥有副作用，例如："),t("code",[s._v('["!src/common.js"]')]),s._v("，表示只要不是"),t("code",[s._v("src/common.js")]),s._v("的文件，都有副作用")])]),s._v(" "),t("blockquote",[t("p",[s._v("这种方式我们一般不处理，通常是一些第三方库在它们自己的"),t("code",[s._v("package.json")]),s._v("中标注")])]),s._v(" "),t("h1",{attrs:{id:"css-tree-shaking"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#css-tree-shaking"}},[s._v("#")]),s._v(" css tree shaking")]),s._v(" "),t("p",[t("code",[s._v("webpack")]),s._v("无法对"),t("code",[s._v("css")]),s._v("完成"),t("code",[s._v("tree shaking")]),s._v("，因为"),t("code",[s._v("css")]),s._v("跟"),t("code",[s._v("es6")]),s._v("没有半毛钱关系")]),s._v(" "),t("p",[s._v("因此对"),t("code",[s._v("css")]),s._v("的"),t("code",[s._v("tree shaking")]),s._v("需要其他插件完成")]),s._v(" "),t("p",[s._v("例如："),t("code",[s._v("purgecss-webpack-plugin")])]),s._v(" "),t("blockquote",[t("p",[s._v("注意："),t("code",[s._v("purgecss-webpack-plugin")]),s._v("对"),t("code",[s._v("css module")]),s._v("无能为力")])])])}),[],!1,null,null,null);t.default=n.exports}}]);