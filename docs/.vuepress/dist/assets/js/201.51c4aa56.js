(window.webpackJsonp=window.webpackJsonp||[]).push([[201],{375:function(t,a,s){"use strict";s.r(a);var r=s(10),e=function(t){t.options.__data__block__={mermaid_382ee167:"sequenceDiagram\n客户端->>服务器: head请求，询问文件信息\n服务器->>客户端: Content-Disposition,Accept-Ranges,Content-Length\n客户端->>服务器: Range:bytes=0-500\n服务器->>客户端: 0-500字节的数据\n客户端->>服务器: Range:bytes=501-1000\n服务器->>客户端: 501-1000字节的数据\n客户端->>服务器: ...\n服务器->>客户端: ...\n客户端->>客户端: 将碎片信息组装成完整文件\n",mermaid_382ee1a4:"sequenceDiagram\nNote left of 客户端: 用户选择文件\nNote left of 客户端: 将文件分割为多个分片\nNote left of 客户端: 得到文件的MD5和每个分片的MD5\n客户端->>服务器: 文件MD5、后缀、分片顺序、每个分片MD5\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 文件还剩哪些分片没有上传？\n服务器->>客户端: 还需要上传的分片MD5\n客户端->>服务器: 上传一个分片\nNote right of 服务器: 所有分片已上传\nNote right of 服务器: 合并所有分片成完整的文件\n服务器->>客户端: 文件的访问地址\n"}},n=Object(r.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"断点续传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#断点续传"}},[t._v("#")]),t._v(" 断点续传")]),t._v(" "),a("h2",{attrs:{id:"下载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载"}},[t._v("#")]),t._v(" 下载")]),t._v(" "),a("p",[t._v("若要实现下载时的断点续传，首先，服务器在响应时，要在头中加入下面的字段")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Accept-Ranges: bytes\n")])])]),a("p",[t._v("这个字段是向客户端表明：我这个文件可以支持传输部分数据，你只需要告诉我你需要的是哪一部分的数据即可，单位是字节")]),t._v(" "),a("p",[t._v("此时，某些支持断点续传的客户端，比如迅雷，它就可以在请求时，告诉服务器需要的数据范围。具体做法是在请求头中加入下面的字段")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("range: bytes=0-5000\n")])])]),a("p",[t._v("客户端告诉服务器：请给我传递0-5000字节范围内的数据即可，无须传输全部数据")]),t._v(" "),a("p",[t._v("完整流程如下")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_382ee167",graph:t.$dataBlock.mermaid_382ee167}}),a("h2",{attrs:{id:"上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传"}},[t._v("#")]),t._v(" 上传")]),t._v(" "),a("p",[t._v("整体来说，实现断点上传的主要思路就是把要上传的文件切分为多个小的数据块然后进行上传")]),t._v(" "),a("p",[a("img",{attrs:{src:"http://mdrs.yuanjin.tech/img/20210918140242.png",alt:"image-20210918140242356"}})]),t._v(" "),a("p",[t._v("虽然分片上传的整体思路一致，但它没有一个统一的、具体的标准，因此需要根据具体的业务场景制定自己的标准。")]),t._v(" "),a("p",[t._v("由于标准的不同，这也就意味着分片上传需要自行编写代码实现。")]),t._v(" "),a("p",[t._v("下面用一种极其简易的流程实现分片上传")]),t._v(" "),a("Mermaid",{attrs:{id:"mermaid_382ee1a4",graph:t.$dataBlock.mermaid_382ee1a4}}),a("h2",{attrs:{id:"示例服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例服务器"}},[t._v("#")]),t._v(" 示例服务器")]),t._v(" "),a("h3",{attrs:{id:"下载-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载-2"}},[t._v("#")]),t._v(" 下载")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper1.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper2.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper3.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper4.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper5.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper6.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper7.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper8.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper9.jpg")]),t._v(" "),a("p",[t._v("http://localhost:8000/download/Wallpaper10.jpg")]),t._v(" "),a("h3",{attrs:{id:"上传-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#上传-2"}},[t._v("#")]),t._v(" 上传")]),t._v(" "),a("h4",{attrs:{id:"文件信息协商"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件信息协商"}},[t._v("#")]),t._v(" 文件信息协商")]),t._v(" "),a("p",[a("strong",[t._v("请求路径")]),t._v("：/api/upload/handshake")]),t._v(" "),a("p",[a("strong",[t._v("请求方法")]),t._v("：POST")]),t._v(" "),a("p",[a("strong",[t._v("字段")]),t._v("：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("字段名")]),t._v(" "),a("th",[t._v("含义")]),t._v(" "),a("th",[t._v("是否必须")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("fileId")]),t._v(" "),a("td",[t._v("文件的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("ext")]),t._v(" "),a("td",[t._v("文件的后缀，例如：.jpg")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("chunkIds")]),t._v(" "),a("td",[t._v("文件分片的编号数组，每个编号是一个MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td"),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("strong",[t._v("可能的响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://localhost:8000/upload/a32d18.jpg'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器已有该文件，无须上传")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-5'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器还需要上传的分片")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("可能发生的失败响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'请携带文件编号'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"分片上传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分片上传"}},[t._v("#")]),t._v(" 分片上传")]),t._v(" "),a("p",[a("strong",[t._v("请求路径")]),t._v("：/api/upload")]),t._v(" "),a("p",[a("strong",[t._v("请求方法")]),t._v("：POST")]),t._v(" "),a("p",[a("strong",[t._v("字段")]),t._v("：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("字段名")]),t._v(" "),a("th",[t._v("含义")]),t._v(" "),a("th",[t._v("是否必须")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("file")]),t._v(" "),a("td",[t._v("分片的二进制数据")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("chunkId")]),t._v(" "),a("td",[t._v("分片的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td",[t._v("fileId")]),t._v(" "),a("td",[t._v("分片所属文件的MD5编码")]),t._v(" "),a("td",[t._v("是")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td"),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("strong",[t._v("上传成功的响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'md5-5'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 服务器还需要上传的分片")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("strong",[t._v("可能发生的失败响应")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("403")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("msg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'请携带文件编号'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])],1)}),[],!1,null,null,null);"function"==typeof e&&e(n);a.default=n.exports}}]);