(window.webpackJsonp=window.webpackJsonp||[]).push([[206],{574:function(t,s,a){"use strict";a.r(s);var n=a(10),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"websocket实战"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#websocket实战"}},[t._v("#")]),t._v(" WebSocket实战")]),t._v(" "),s("h2",{attrs:{id:"websocket-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#websocket-api"}},[t._v("#")]),t._v(" WebSocket API")]),t._v(" "),s("p",[t._v("https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket/WebSocket")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" ws "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSocket")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"地址"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建websocket连接，浏览器自动握手")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件：握手完成后触发")]),t._v("\nws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onopen")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'连接到了服务器'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件：收到服务器消息后触发")]),t._v("\nws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onmessage")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// e.data：服务器发送的消息")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事件：连接关闭后触发")]),t._v("\nws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onclose")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'连接关闭了'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送消息到服务器")]),t._v("\nws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("消息"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 连接状态：0-正在连接中  1-已连接  2-正在关闭中  3-已关闭")]),t._v("\nws"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyState\n")])])]),s("h2",{attrs:{id:"socket-io"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#socket-io"}},[t._v("#")]),t._v(" Socket.io")]),t._v(" "),s("blockquote",[s("p",[t._v("官网：https://socket.io/")])]),t._v(" "),s("p",[t._v("原生的接口虽然简单，但是在实际应用中会造成很多麻烦")]),t._v(" "),s("p",[t._v("比如一个页面，既有K线，也有实时聊天，于是：")]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"http://mdrs.yuanjin.tech/img/20211029113505.png",alt:"image-20211029113505007"}}),t._v(" "),s("p",[t._v("上图是一段时间中服务器给客户端推送的数据，你能区分这些数据都是什么意思吗？")]),t._v(" "),s("p",[t._v("这就是问题所在：连接双方可以在任何时候发送任何类型的数据，另一方必须要清楚这个数据的含义是什么")]),t._v(" "),s("blockquote",[s("p",[t._v("回忆HTTP是如何处理这个问题的")]),t._v(" "),s("p",[t._v("你会如何解决这个问题")])]),t._v(" "),s("p",[t._v("虽然我们可以自行解决这些问题，但毕竟麻烦")]),t._v(" "),s("p",[s("strong",[t._v("Socket.io")]),t._v("帮助我们解决了这些问题，它把消息放到不同的"),s("strong",[t._v("事件")]),t._v("中，通过监听和触发事件来实现对不同消息的处理")]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"http://mdrs.yuanjin.tech/img/20211029123907.png",alt:"image-20211029123907859"}}),t._v(" "),s("p",[t._v("客户端和服务器双方事先约定好不同的事件，事件由谁监听，由谁触发，就可以把各种消息进行有序管理了")]),t._v(" "),s("p",[s("strong",[t._v("注意，Socket.io为了实现这些要求，对消息格式进行了特殊处理，因此如果一方要使用Socket.io，双方必须都使用")])]),t._v(" "),s("p",[t._v("在客户端，使用Socket.io是非常简单的")]),t._v(" "),s("p",[t._v("参见：https://socket.io/docs/v4/client-installation/")]),t._v(" "),s("blockquote",[s("p",[t._v("在约定事件名时要注意，Socket.io有一些预定义的事件名，比如message、connect等")]),t._v(" "),s("p",[t._v("为了避免冲突，建议自定义事件名使用一个特殊的前缀，比如"),s("code",[t._v("$")])])]),t._v(" "),s("blockquote",[s("p",[t._v("除此之外，Socket.io对低版本浏览器还进行了兼容处理")]),t._v(" "),s("p",[t._v("如果浏览器不支持WebSocket，Socket.io将使用长轮询（long polling）处理")]),t._v(" "),s("p",[t._v("另外，Socket.io还支持使用"),s("em",[t._v("命名空间")]),t._v("来进一步隔离业务，要了解这些高级功能，以及Socket.io的更多API，请参阅其"),s("a",{attrs:{href:"https://socket.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"接口文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接口文档"}},[t._v("#")]),t._v(" 接口文档")]),t._v(" "),s("h3",{attrs:{id:"测试接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试接口"}},[t._v("#")]),t._v(" 测试接口")]),t._v(" "),s("p",[s("strong",[t._v("连接地址")]),t._v("：ws://localhost:9527")]),t._v(" "),s("p",[s("strong",[t._v("服务器消息：")])]),t._v(" "),s("ol",[s("li",[t._v("服务器每隔3秒钟会发送一个消息给客户端")]),t._v(" "),s("li",[t._v("每次收到客户端的消息后，服务器会回应一个消息")])]),t._v(" "),s("h3",{attrs:{id:"聊天室接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#聊天室接口"}},[t._v("#")]),t._v(" 聊天室接口")]),t._v(" "),s("p",[s("strong",[t._v("连接地址")]),t._v("：ws://localhost:9528")]),t._v(" "),s("p",[s("strong",[t._v("服务器触发的事件/客户端需要监听的事件：")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("事件名")]),t._v(" "),s("th",[t._v("触发时机")]),t._v(" "),s("th",[t._v("传递的消息")]),t._v(" "),s("th",[t._v("传递消息示例")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("$updateUser")]),t._v(" "),s("td",[t._v("有新用户进入"),s("br"),t._v("有老用户退出"),s("br"),t._v("自己进入")]),t._v(" "),s("td",[t._v("当前聊天室的用户数组")]),t._v(" "),s("td",[t._v("['张三', '李四']")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("$name")]),t._v(" "),s("td",[t._v("自己进入")]),t._v(" "),s("td",[t._v("分配的用户名称")]),t._v(" "),s("td",[t._v('"张三"')])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("$history")]),t._v(" "),s("td",[t._v("自己进入")]),t._v(" "),s("td",[t._v("历史聊天记录")]),t._v(" "),s("td",[t._v("[{"),s("br"),t._v('  name:"张三",'),s("br"),t._v('  content:"你好",'),s("br"),t._v("  date: 1635484786373"),s("br"),t._v("}]")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("$message")]),t._v(" "),s("td",[t._v("其他人发送消息")]),t._v(" "),s("td",[t._v("消息对象")]),t._v(" "),s("td",[t._v("{"),s("br"),t._v('  name:"张三",'),s("br"),t._v('  content:"你好",'),s("br"),t._v("  date: 1635484786373"),s("br"),t._v("}")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}}),t._v(" "),s("td"),t._v(" "),s("td"),t._v(" "),s("td")])])]),t._v(" "),s("p",[s("strong",[t._v("客户端触发的事件/服务器需要监听的事件：")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("事件名")]),t._v(" "),s("th",[t._v("触发时机")]),t._v(" "),s("th",[t._v("传递的消息")]),t._v(" "),s("th",[t._v("传递消息示例")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("$message")]),t._v(" "),s("td",[t._v("发送聊天消息")]),t._v(" "),s("td",[t._v("消息字符串")]),t._v(" "),s("td",[t._v('"你好！"')])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);